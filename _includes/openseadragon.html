<form id="enteriiifitem" style="padding-bottom: 20px">
<input style="width:100%" type="text" name="iiifurl" id="iiifurl" placeholder="Load image, should be info.json link">
</form>
<p><b>Example images from other institutions</b></p>
{% for item in site.data.preloadedos %}
<a onclick="localStorage.setItem('osviewer', '{{item}}'); location.reload()">{{item}}</a><br>
{% endfor %}
<script src="https://annotorious.github.io/js/openseadragon/openseadragon.min.js"></script>
<script src="https://annotorious.github.io/latest/annotorious.min.js"></script>
<script src="https://annotorious.github.io/js/highlight.js"></script>
<script type="text/javascript" src="https://annotorious.github.io/latest/anno-fancybox.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://annotorious.github.io/latest/annotorious.css">

<button id="map-annotate-button" onclick="anno.activateSelector();" href="#">
  ADD ANNOTATION
</button>
<div id="openseadragon" class="viewer"></div>

<script>
document.getElementById("enteriiifitem").onsubmit= function() {
  localStorage.setItem('osviewer', document.getElementById("iiifurl").value);
  location.reload();
  return false;
}

document.getElementById("openseadragon").addEventListener("load", getUrl());
function heighwidth (tilesource) {
  $.ajax({
    type : "get",
    url : tilesource,
    success : function(data) {
      var height = data['height'];
      var width = data['width'];
      loadanno(tilesource, height, width)
    }
  });
}

function getUrl() {
  var tilesource = localStorage['osviewer'] ? localStorage['osviewer'] : '{{site.data.preloadedos[0]}}';
  heighwidth(tilesource)
}

function loadanno(tilesource, height, width) {
  var baseurl = tilesource.split("/info.json")[0];
  var aspect_ratio = width/height;
  var tilesources = {
    type: 'legacy-image-pyramid',
    levels: [{
      url: `${baseurl}/full/full/0/default.jpg`,
      height: height,
      width: width
    }]
  }
  var viewer = OpenSeadragon({
    id: "openseadragon",
    prefixUrl: "https://annotorious.github.io/js/openseadragon/images/",
    showNavigator: false,
    tileSources: tilesources
  });
  anno.makeAnnotatable(viewer);
  annotorious.plugin.addTags = function() { }
  annotorious.plugin.addTags.prototype.onInitAnnotator = function(annotator) {
    annotator.editor.addField(function(annotation) {
      var tags = annotation ? annotation.tags : '';
      return 'Tags: <input type="text" name="tags" id="tags" value="' + tags + '">'
    });
    annotator.popup.addField(function(annotation) {
      return '<em style="color: white">Tags: ' + annotation.tags + '</em>';
    })
  }

  anno.addPlugin('addTags', {});
    annotorious.plugin.selectType = function() { }
    annotorious.plugin.selectType.prototype.onInitAnnotator = function(annotator) {
      annotator.editor.addField(function(annotation) {
        var shapetype = annotation ? annotation.shapetype : 'rect';
        return 'Type: <input type="text" name="shapetype" id="shapetype" value="' + shapetype + '">'
      });
      annotator.popup.addField(function(annotation) {
        return '<em style="color: white">Type: ' + annotation.shapetype + '</em>';
      })
  }
  anno.addPlugin('selectType', {});
  annotorious.plugin.addAuthor = function() { }
  annotorious.plugin.addAuthor.prototype.onInitAnnotator = function(annotator) {
    annotator.editor.addField(function(annotation) {
      var author = annotation ? annotation.author : '';
      return 'Author: <input type="text" name="author" id="author" value="' + author + '">'
    });
    annotator.popup.addField(function(annotation) {
      return '<em style="color: white">Author: ' + annotation.author + '</em>';
    })
  }
  anno.addPlugin('addAuthor', {});

  anno.showAnnotations(viewer)
  viewer.addHandler('open', function(){
    var all_annos = []
    {% for annotation in site.annotations %}
      var annotation = JSON.parse({{annotation.content | jsonify}})
      if (annotation['@context'].indexOf('w3') > -1 && annotation.target && tilesource.indexOf(annotation.target.id.split("#xywh=")[0]) > -1){
        all_annos.push(annotation)
        var xywh = annotation.target.id.split("#xywh=").slice(-1)[0].split(",");
        var cords = viewer.viewport.imageToViewportRectangle(xywh[0], xywh[1], xywh[2], xywh[3]);
        var id = `${cords['x'].toFixed(2)}${cords['y'].toFixed(2)}${cords['width'].toFixed(2)}${cords['height'].toFixed(2)}`
        var loadanno = {}
        loadanno['src'] = 'dzi://openseadragon/something'
        body = Array.isArray(annotation['body']) ? annotation['body'] : [annotation['body']];
        var tags = []
        for (var jar=0; jar<body.length; jar++){
          if(body[jar]['purpose'] != 'tagging'){
            loadanno['text'] = body[jar]['value'];
            loadanno['shapetype'] = body[jar]['selector'] ? body[jar]['selector']['value'] : 'rect';
          } else {
            tags.push(body[jar]['value'])
          }
        }
        loadanno['shapes'] = [{"type": "rect", "geometry": cords}]
        loadanno['tags'] = tags.join(", ");
        loadanno['id'] = annotation['@id'];
        loadanno['created'] = annotation['created'];
        loadanno['modified'] = annotation['modified'];
        var creator = annotation.creator ? annotation.creator.join(", ") : "";
        loadanno['author'] = creator;
        anno.addAnnotation(loadanno)
      }
    {% endfor %}
  });

  anno.addHandler('onAnnotationCreated', function(annotation) {
    var annotation_text = buildAnno(annotation, annotorious, viewer, baseurl)
    var senddata = {'json': annotation_text }
    write_annotation(senddata, 'create', '{{site.api_server}}', annotation)
  });

  anno.addHandler('onAnnotationUpdated', function(annotation) {
    var annotation_text = buildAnno(annotation, annotorious, viewer, baseurl)
    var senddata = {'json': annotation_text,'id': annotation['id']}
    write_annotation(senddata, 'update', '{{site.api_server}}')
  });

  anno.addHandler('onAnnotationRemoved', function(annotation) {
    var senddata = {'listuri': baseurl, 'id': annotation['id'] }
    write_annotation(senddata, 'delete', '{{site.api_server}}')
  });

}
</script>